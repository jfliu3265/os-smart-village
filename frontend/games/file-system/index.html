<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‘åº„æ¡£æ¡ˆå®¤ - æ–‡ä»¶ç³»ç»Ÿå­¦ä¹ </title>
    <link rel="stylesheet" href="../../styles/main.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 36px;
            margin: 0;
        }

        .main-content {
            display: flex;
            padding: 20px;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .file-explorer {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        /* æ–‡ä»¶æ ‘ */
        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        .tree-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .tree-item:hover {
            background: #e9ecef;
        }

        .tree-item.selected {
            background: #3498db;
            color: white;
        }

        .tree-item .icon {
            font-size: 18px;
        }

        .tree-children {
            margin-left: 20px;
        }

        /* æ–‡ä»¶å†…å®¹åŒºåŸŸ */
        .file-area {
            flex: 1;
            background: white;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            padding: 20px;
            margin-top: 15px;
            overflow-y: auto;
        }

        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tool-btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        /* è¾“å…¥è¡¨å• */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        /* æ–‡ä»¶å›¾æ ‡ */
        .file-icon {
            font-size: 48px;
            text-align: center;
            margin: 20px 0;
        }

        /* æƒé™è®¾ç½® */
        .permission-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .permission-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* è·¯å¾„å¯¼èˆª */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .breadcrumb-item {
            cursor: pointer;
            color: #495057;
        }

        .breadcrumb-item:hover {
            color: #3498db;
            text-decoration: underline;
        }

        /* inodeä¿¡æ¯ */
        .inode-info {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
        }

        /* æœç´¢ç»“æœ */
        .search-results {
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        /* å­—èŠ‚å”å¯¹è¯æ¡† */
        .uncle-dialog {
            background: #fff3cd;
            border: 3px solid #ffc107;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
        }

        .uncle-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: #856404;
            font-weight: bold;
        }

        .uncle-message {
            color: #856404;
            line-height: 1.6;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s;
        }

        .back-btn:hover {
            transform: scale(1.05);
            background: #2980b9;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='../../index.html'">
        â† è¿”å›æ‘åº„
    </button>

    <div class="game-container">
        <div class="header">
            <h1>ğŸ“ æ‘åº„æ¡£æ¡ˆå®¤ - æ–‡ä»¶ç³»ç»Ÿå­¦ä¹ </h1>
            <p>å­¦ä¹ å¦‚ä½•ç»„ç»‡å’Œç®¡ç†æ–‡ä»¶ï¼Œå°±åƒç®¡ç†æ‘åº„çš„æ¡£æ¡ˆä¸€æ ·ï¼</p>
        </div>

        <div class="main-content">
            <div class="file-explorer">
                <!-- è·¯å¾„å¯¼èˆª -->
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item" onclick="game.navigateTo('/')">æ ¹ç›®å½•</span>
                </div>

                <!-- å·¥å…·æ  -->
                <div class="toolbar">
                    <button class="tool-btn btn-primary" onclick="game.showCreateFolder()">
                        ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹
                    </button>
                    <button class="tool-btn btn-success" onclick="game.showCreateFile()">
                        ğŸ“„ æ–°å»ºæ–‡ä»¶
                    </button>
                    <button class="tool-btn btn-warning" onclick="game.showDelete()">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                    <button class="tool-btn btn-info" onclick="game.showPermissions()">
                        ğŸ”’ æƒé™è®¾ç½®
                    </button>
                    <button class="tool-btn btn-primary" onclick="game.showSearch()">
                        ğŸ” æœç´¢æ–‡ä»¶
                    </button>
                </div>

                <!-- æ–‡ä»¶æ ‘è§†å›¾ -->
                <div class="file-tree" id="fileTree">
                    <!-- æ–‡ä»¶æ ‘å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- æ–‡ä»¶/æ–‡ä»¶å¤¹è¯¦ç»†ä¿¡æ¯ -->
                <div class="file-area" id="fileArea">
                    <div class="file-icon">ğŸ“</div>
                    <h3 style="text-align: center;">é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹æŸ¥çœ‹è¯¦æƒ…</h3>
                </div>
            </div>

            <div class="sidebar">
                <!-- inodeä¿¡æ¯ -->
                <div class="panel">
                    <div class="panel-title">ğŸ“Š Inode ä¿¡æ¯</div>
                    <div class="inode-info" id="inodeInfo">
                        é€‰æ‹©æ–‡ä»¶æŸ¥çœ‹inodeä¿¡æ¯...
                    </div>
                </div>

                <!-- æ–‡ä»¶ç»Ÿè®¡ -->
                <div class="panel">
                    <div class="panel-title">ğŸ“ˆ æ¡£æ¡ˆç»Ÿè®¡</div>
                    <div class="stats-grid">
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #3498db;" id="totalFiles">0</div>
                            <div style="font-size: 12px; color: #7f8c8d;">æ–‡ä»¶æ€»æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #27ae60;" id="totalFolders">0</div>
                            <div style="font-size: 12px; color: #7f8c8d;">æ–‡ä»¶å¤¹æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 24px; font-weight: bold; color: #f39c12;" id="totalSize">0KB</div>
                            <div style="font-size: 12px; color: #7f8c8d;">æ€»å¤§å°</div>
                        </div>
                    </div>
                </div>

                <!-- å­—èŠ‚å”å¯¹è¯æ¡† -->
                <div class="panel">
                    <div class="panel-title">ğŸ‘´ å­—èŠ‚å”</div>
                    <div class="uncle-dialog">
                        <div class="uncle-header">
                            <span style="font-size: 24px;">ğŸ‘´</span>
                            <span>å­—èŠ‚å”</span>
                        </div>
                        <div class="uncle-message" id="uncleMessage">
                            æ¬¢è¿æ¥åˆ°æ‘åº„æ¡£æ¡ˆå®¤ï¼è¿™é‡Œå­˜æ”¾ç€æ‘åº„æ‰€æœ‰çš„é‡è¦æ–‡ä»¶ã€‚
                            æ–‡ä»¶ç³»ç»Ÿå°±åƒä¸€ä¸ªæ™ºèƒ½æ¡£æ¡ˆæŸœï¼Œå¯ä»¥å¸®ä½ å¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„æ–‡ä»¶ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../../common/api-client.js"></script>
    <script>
        class FileSystemGame {
            constructor() {
                this.currentPath = '/';
                this.selectedItem = null;
                this.fileSystem = this.initFileSystem();
                this.nextInode = 100;
                this.init();
            }

            initFileSystem() {
                return {
                    '/': {
                        type: 'dir',
                        inode: 1,
                        children: {
                            'home': {
                                type: 'dir',
                                inode: 2,
                                children: {
                                    'æ‘æ°‘æ¡£æ¡ˆ.txt': {
                                        type: 'file',
                                        inode: 3,
                                        size: 2,
                                        permissions: 'rw-r--r--',
                                        content: 'æ‘æ°‘åŸºæœ¬ä¿¡æ¯ç™»è®°è¡¨'
                                    },
                                    'åœŸåœ°è¯.pdf': {
                                        type: 'file',
                                        inode: 4,
                                        size: 128,
                                        permissions: 'rw-------',
                                        content: '[PDFæ–‡ä»¶]'
                                    }
                                }
                            },
                            'public': {
                                type: 'dir',
                                inode: 5,
                                children: {
                                    'æ‘è§„æ°‘çº¦.doc': {
                                        type: 'file',
                                        inode: 6,
                                        size: 16,
                                        permissions: 'rw-rw-r--',
                                        content: 'æ‘åº„è§„ç« åˆ¶åº¦æ–‡æ¡£'
                                    },
                                    'å…¬å‘Š.txt': {
                                        type: 'file',
                                        inode: 7,
                                        size: 4,
                                        permissions: 'r--r--r--',
                                        content: 'æœ€æ–°é€šçŸ¥å…¬å‘Š'
                                    }
                                }
                            }
                        }
                    }
                };
            }

            init() {
                this.renderFileTree();
                this.updateStats();
            }

            getItem(path) {
                const parts = path.split('/').filter(p => p);
                let current = this.fileSystem['/'];

                for (let part of parts) {
                    if (current.children && current.children[part]) {
                        current = current.children[part];
                    } else {
                        return null;
                    }
                }
                return current;
            }

            navigateTo(path) {
                this.currentPath = path;
                this.selectedItem = null;
                this.renderFileTree();
                this.updateBreadcrumb();
                this.updateFileArea(this.getItem(path));
            }

            renderFileTree() {
                const container = document.getElementById('fileTree');
                container.innerHTML = '';

                const currentItem = this.getItem(this.currentPath);
                if (!currentItem || !currentItem.children) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d;">ç©ºæ–‡ä»¶å¤¹</div>';
                    return;
                }

                Object.entries(currentItem.children).forEach(([name, item]) => {
                    const div = document.createElement('div');
                    div.className = 'tree-item slide-in';

                    const icon = document.createElement('span');
                    icon.className = 'icon';
                    icon.textContent = item.type === 'dir' ? 'ğŸ“' : 'ğŸ“„';

                    const text = document.createElement('span');
                    text.textContent = name;

                    div.appendChild(icon);
                    div.appendChild(text);

                    div.onclick = () => {
                        document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));
                        div.classList.add('selected');
                        this.selectedItem = { name, item, path: this.currentPath === '/' ? '/' + name : this.currentPath + '/' + name };
                        this.updateInodeInfo(item);
                    };

                    if (item.type === 'dir') {
                        div.ondblclick = () => {
                            const newPath = this.currentPath === '/' ? '/' + name : this.currentPath + '/' + name;
                            this.navigateTo(newPath);
                        };
                    }

                    container.appendChild(div);
                });
            }

            updateBreadcrumb() {
                const container = document.getElementById('breadcrumb');
                const parts = this.currentPath.split('/').filter(p => p);

                let html = '<span class="breadcrumb-item" onclick="game.navigateTo(\'/\')">æ ¹ç›®å½•</span>';

                let path = '';
                parts.forEach((part, index) => {
                    path += '/' + part;
                    html += ' <span style="color: #adb5bd;">â€º</span> ';
                    html += `<span class="breadcrumb-item" onclick="game.navigateTo('${path}')">${part}</span>`;
                });

                container.innerHTML = html;
            }

            updateFileArea(item) {
                const area = document.getElementById('fileArea');
                if (!item) {
                    area.innerHTML = '<div class="file-icon">â“</div><h3 style="text-align: center;">é¡¹ç›®ä¸å­˜åœ¨</h3>';
                    return;
                }

                if (item.type === 'dir') {
                    area.innerHTML = `
                        <div class="file-icon">ğŸ“</div>
                        <h3 style="text-align: center;">${this.currentPath === '/' ? 'æ ¹ç›®å½•' : this.getItemName(this.currentPath)}</h3>
                        <p style="text-align: center; color: #7f8c8d;">åŒ…å« ${Object.keys(item.children || {}).length} ä¸ªé¡¹ç›®</p>
                    `;
                } else {
                    area.innerHTML = `
                        <div class="file-icon">ğŸ“„</div>
                        <h3 style="text-align: center;">${this.getItemName(this.currentPath)}</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <strong>æ–‡ä»¶å†…å®¹ï¼š</strong><br>
                            ${item.content || 'ç©ºæ–‡ä»¶'}
                        </div>
                    `;
                }
            }

            getItemName(path) {
                const parts = path.split('/').filter(p => p);
                return parts[parts.length - 1] || 'æ ¹ç›®å½•';
            }

            updateInodeInfo(item) {
                if (!item) {
                    document.getElementById('inodeInfo').innerHTML = 'é€‰æ‹©æ–‡ä»¶æŸ¥çœ‹inodeä¿¡æ¯...';
                    return;
                }

                const info = `
<strong>Inodeç¼–å·:</strong> ${item.inode}
<strong>ç±»å‹:</strong> ${item.type === 'dir' ? 'ç›®å½•' : 'æ–‡ä»¶'}
<strong>å¤§å°:</strong> ${item.size || 0} KB
<strong>æƒé™:</strong> ${item.permissions || 'rw-r--r--'}
<strong>é“¾æ¥æ•°:</strong> 1
<strong>ä¿®æ”¹æ—¶é—´:</strong> 2025-01-05 10:30:00
                `;

                document.getElementById('inodeInfo').innerHTML = info;
            }

            showCreateFolder() {
                const name = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼š');
                if (!name) return;

                const currentItem = this.getItem(this.currentPath);
                if (!currentItem.children) {
                    currentItem.children = {};
                }

                currentItem.children[name] = {
                    type: 'dir',
                    inode: this.nextInode++,
                    children: {}
                };

                this.renderFileTree();
                this.updateStats();
                this.showMessage(`æ–‡ä»¶å¤¹ "${name}" åˆ›å»ºæˆåŠŸï¼`);
            }

            showCreateFile() {
                const name = prompt('è¯·è¾“å…¥æ–‡ä»¶åç§°ï¼ˆå¦‚ï¼šreadme.txtï¼‰ï¼š');
                if (!name) return;

                const size = Math.floor(Math.random() * 100) + 1;

                const currentItem = this.getItem(this.currentPath);
                if (!currentItem.children) {
                    currentItem.children = {};
                }

                currentItem.children[name] = {
                    type: 'file',
                    inode: this.nextInode++,
                    size: size,
                    permissions: 'rw-r--r--',
                    content: `è¿™æ˜¯ ${name} çš„å†…å®¹`
                };

                this.renderFileTree();
                this.updateStats();
                this.showMessage(`æ–‡ä»¶ "${name}" åˆ›å»ºæˆåŠŸï¼\nå®ƒè¢«åˆ†é…äº† inode ${this.nextInode - 1}`);
            }

            showDelete() {
                if (!this.selectedItem) {
                    alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼');
                    return;
                }

                if (confirm(`ç¡®å®šè¦åˆ é™¤ "${this.selectedItem.name}" å—ï¼Ÿ`)) {
                    const parentPath = this.currentPath;
                    const parentItem = this.getItem(parentPath);

                    if (parentItem && parentItem.children) {
                        delete parentItem.children[this.selectedItem.name];
                        this.renderFileTree();
                        this.updateStats();
                        this.showMessage(`"${this.selectedItem.name}" å·²åˆ é™¤ï¼`);
                        this.selectedItem = null;
                    }
                }
            }

            showPermissions() {
                if (!this.selectedItem) {
                    alert('è¯·å…ˆé€‰æ‹©è¦è®¾ç½®æƒé™çš„æ–‡ä»¶ï¼');
                    return;
                }

                const permissions = prompt('è®¾ç½®æƒé™ï¼ˆå¦‚ï¼šrwxr-xr-xï¼‰ï¼š', this.selectedItem.item.permissions || 'rw-r--r--');
                if (permissions) {
                    this.selectedItem.item.permissions = permissions;
                    this.updateInodeInfo(this.selectedItem.item);
                    this.showMessage(`æƒé™å·²æ›´æ–°ä¸ºï¼š${permissions}\nè§£é‡Šï¼šæ‰€æœ‰è€…${permissions.substr(0,3)} ç»„${permissions.substr(3,3)} å…¶ä»–äºº${permissions.substr(6,3)}`);
                }
            }

            showSearch() {
                const query = prompt('è¯·è¾“å…¥è¦æœç´¢çš„æ–‡ä»¶åï¼š');
                if (!query) return;

                const results = [];
                this.searchRecursive(this.fileSystem['/'], '', query, results);

                if (results.length === 0) {
                    alert('æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶');
                    return;
                }

                const message = `æ‰¾åˆ° ${results.length} ä¸ªæ–‡ä»¶ï¼š\n` + results.join('\n');
                this.showMessage(message);
            }

            searchRecursive(item, path, query, results) {
                if (item.children) {
                    Object.entries(item.children).forEach(([name, child]) => {
                        const fullPath = path + '/' + name;
                        if (name.toLowerCase().includes(query.toLowerCase())) {
                            results.push(fullPath + (child.type === 'dir' ? '/' : ''));
                        }
                        if (child.type === 'dir') {
                            this.searchRecursive(child, fullPath, query, results);
                        }
                    });
                }
            }

            updateStats() {
                let files = 0;
                let folders = 0;
                let size = 0;

                this.countRecursive(this.fileSystem['/'], files, folders, size);

                document.getElementById('totalFiles').textContent = files;
                document.getElementById('totalFolders').textContent = folders;
                document.getElementById('totalSize').textContent = size + 'KB';
            }

            countRecursive(item, files, folders, size) {
                if (item.children) {
                    Object.values(item.children).forEach(child => {
                        if (child.type === 'dir') {
                            folders++;
                            this.countRecursive(child, files, folders, size);
                        } else {
                            files++;
                            size += child.size || 0;
                        }
                    });
                }
            }

            showMessage(msg) {
                document.getElementById('uncleMessage').innerHTML = msg.replace(/\n/g, '<br>');
            }

            async showHint() {
                try {
                    const hint = await OS_VILLAGE_API.getHint(
                        'session_' + Date.now(),
                        {
                            game: 'file-system',
                            path: this.currentPath,
                            stage: 'learning'
                        }
                    );
                    this.showMessage('ğŸ‘´ å­—èŠ‚å”<br>' + hint.hint);
                } catch (error) {
                    this.showMessage('ğŸ‘´ å­—èŠ‚å”<br>æ–‡ä»¶ç³»ç»Ÿå°±åƒä¸€ä¸ªæ™ºèƒ½æ¡£æ¡ˆæŸœã€‚inodeå°±åƒæ¡£æ¡ˆæŸœä¸Šçš„ç¼–å·ï¼Œé€šè¿‡å®ƒå¯ä»¥å¿«é€Ÿæ‰¾åˆ°æ–‡ä»¶ã€‚è¯•è¯•åˆ›å»ºä¸€äº›æ–‡ä»¶å’Œæ–‡ä»¶å¤¹å§ï¼');
                }
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        const game = new FileSystemGame();
    </script>
</body>
</html>
