<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ„æºäº‰ç«¯è°ƒè§£ - æ­»é”å¤„ç†å­¦ä¹ </title>
    <link rel="stylesheet" href="../../styles/main.css">
    <style>
        .game-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .game-area {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .side-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .strategy-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: 2px solid #e74c3c;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .strategy-btn:hover {
            background: #e74c3c;
            color: white;
            transform: translateX(5px);
        }

        .strategy-btn.active {
            background: #e74c3c;
            color: white;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #e74c3c;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .process-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .process-item {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .process-item:hover {
            transform: scale(1.05);
        }

        .process-item.deadlocked {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .resource-pool {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .resource-item {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .uncle-dialog {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            position: relative;
        }

        .uncle-dialog::before {
            content: 'ğŸ‘´ å­—èŠ‚å”';
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #856404;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .request-arrow {
            font-size: 24px;
            margin: 0 10px;
        }

        .deadlock-indicator {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .resource-allocation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .resource-allocation-table th,
        .resource-allocation-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .resource-allocation-table th {
            background: #3498db;
            color: white;
        }

        .held {
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 2px;
        }

        .waiting {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 2px;
        }
    </style>
</head>
<body>
    <!-- è¿”å›æŒ‰é’® -->
    <button class="back-btn btn btn-primary" onclick="window.location.href='../../index.html'">
        â† è¿”å›æ‘åº„
    </button>

    <div class="game-container">
        <!-- æ¸¸æˆä¸»åŒºåŸŸ -->
        <div class="game-area">
            <h1 style="text-align: center; margin-bottom: 20px;">
                âš–ï¸ èµ„æºäº‰ç«¯è°ƒè§£ - æ­»é”å¤„ç†å­¦ä¹ 
            </h1>

            <!-- æ­»é”æ£€æµ‹æŒ‡ç¤ºå™¨ -->
            <div id="deadlockIndicator" style="display: none;" class="deadlock-indicator">
                âš ï¸ æ£€æµ‹åˆ°æ­»é”ï¼è¿›ç¨‹äº’ç›¸ç­‰å¾…èµ„æºï¼Œå½¢æˆå¾ªç¯ç­‰å¾…ï¼
            </div>

            <!-- èµ„æºæ±  -->
            <h3 style="margin-top: 20px;">ğŸ“¦ èµ„æºæ± </h3>
            <div class="resource-pool" id="resourcePool">
                <!-- èµ„æºå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- è¿›ç¨‹çŠ¶æ€ -->
            <h3 style="margin-top: 20px;">ğŸ‘¥ æ‘æ°‘ï¼ˆè¿›ç¨‹ï¼‰çŠ¶æ€</h3>
            <div class="process-container" id="processContainer">
                <!-- è¿›ç¨‹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- èµ„æºåˆ†é…è¡¨ -->
            <h3 style="margin-top: 20px;">ğŸ“Š èµ„æºåˆ†é…è¡¨</h3>
            <table class="resource-allocation-table">
                <thead>
                    <tr>
                        <th>è¿›ç¨‹</th>
                        <th>å·²æŒæœ‰èµ„æº</th>
                        <th>ç­‰å¾…èµ„æº</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="allocationTable">
                    <!-- è¡¨æ ¼å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="game.startSimulation()">â–¶ å¼€å§‹æ¨¡æ‹Ÿ</button>
                <button class="btn btn-warning" onclick="game.resetSimulation()">â†» é‡ç½®</button>
                <button class="btn btn-success" onclick="game.detectDeadlock()">ğŸ” æ£€æµ‹æ­»é”</button>
                <button class="btn btn-danger" onclick="game.resolveDeadlock()">ğŸ’¥ è§£é™¤æ­»é”</button>
            </div>

            <!-- å­—èŠ‚å”å¯¹è¯æ¡† -->
            <div class="uncle-dialog" id="uncleDialog">
                æ¬¢è¿æ¥åˆ°èµ„æºäº‰ç«¯è°ƒè§£ä¸­å¿ƒï¼æˆ‘æ˜¯å­—èŠ‚å”ã€‚
                åœ¨è¿™é‡Œï¼Œä½ å°†å­¦ä¹ æ­»é”çš„äº§ç”ŸåŸå› å’Œè§£å†³æ–¹æ³•ã€‚
                æ­»é”å°±åƒæ‘æ°‘ä»¬äº’ç›¸ç­‰å¾…å¯¹æ–¹çš„èµ„æºï¼Œè°éƒ½æ— æ³•ç»§ç»­å·¥ä½œã€‚
            </div>
        </div>

        <!-- ä¾§è¾¹é¢æ¿ -->
        <div class="side-panel">
            <!-- æ­»é”å¤„ç†ç­–ç•¥ -->
            <div class="panel-card">
                <div class="panel-title">ğŸ› ï¸ æ­»é”å¤„ç†ç­–ç•¥</div>
                <button class="strategy-btn active" onclick="game.setStrategy('prevention')">
                    æ­»é”é¢„é˜²
                </button>
                <button class="strategy-btn" onclick="game.setStrategy('avoidance')">
                    æ­»é”é¿å…
                </button>
                <button class="strategy-btn" onclick="game.setStrategy('detection')">
                    æ­»é”æ£€æµ‹
                </button>
                <button class="strategy-btn" onclick="game.setStrategy('recovery')">
                    æ­»é”æ¢å¤
                </button>
            </div>

            <!-- æ­»é”æ¡ä»¶ -->
            <div class="panel-card">
                <div class="panel-title">âš ï¸ æ­»é”å››ä¸ªå¿…è¦æ¡ä»¶</div>
                <div class="info-box">
                    <strong>1. äº’æ–¥æ¡ä»¶</strong><br>
                    èµ„æºä¸èƒ½å…±äº«ï¼Œä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨
                </div>
                <div class="info-box">
                    <strong>2. æŒæœ‰å¹¶ç­‰å¾…</strong><br>
                    è¿›ç¨‹æŒæœ‰è‡³å°‘ä¸€ä¸ªèµ„æºï¼ŒåŒæ—¶ç­‰å¾…è·å–å…¶ä»–èµ„æº
                </div>
                <div class="info-box">
                    <strong>3. ä¸å¯æŠ¢å </strong><br>
                    èµ„æºä¸èƒ½è¢«å¼ºåˆ¶ä»æŒæœ‰è€…é‚£é‡ŒæŠ¢å 
                </div>
                <div class="info-box">
                    <strong>4. å¾ªç¯ç­‰å¾…</strong><br>
                    å­˜åœ¨è¿›ç¨‹çš„å¾ªç¯ç­‰å¾…é“¾ P0â†’P1â†’P2â†’...â†’P0
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="panel-card">
                <div class="panel-title">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">è¿›ç¨‹æ€»æ•°</div>
                        <div class="stat-value" id="totalProcesses">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">èµ„æºæ€»æ•°</div>
                        <div class="stat-value" id="totalResources">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ç­‰å¾…è¿›ç¨‹</div>
                        <div class="stat-value" id="waitingProcesses">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ­»é”çŠ¶æ€</div>
                        <div class="stat-value" id="deadlockStatus">æ— </div>
                    </div>
                </div>
            </div>

            <!-- ç­–ç•¥è¯´æ˜ -->
            <div class="panel-card">
                <div class="panel-title">ğŸ“– ç­–ç•¥è¯´æ˜</div>
                <div class="info-box" id="strategyInfo">
                    <strong>æ­»é”é¢„é˜²</strong><br>
                    é€šè¿‡ç ´åæ­»é”å››ä¸ªå¿…è¦æ¡ä»¶ä¸­çš„è‡³å°‘ä¸€ä¸ªæ¥é¢„é˜²æ­»é”çš„å‘ç”Ÿã€‚
                    å¸¸ç”¨æ–¹æ³•ï¼šèµ„æºä¸€æ¬¡æ€§åˆ†é…ã€å…è®¸èµ„æºæŠ¢å ã€æœ‰åºèµ„æºåˆ†é…ã€‚
                </div>
            </div>

            <!-- é“¶è¡Œå®¶ç®—æ³•æ¼”ç¤º -->
            <div class="panel-card">
                <div class="panel-title">ğŸ¦ é“¶è¡Œå®¶ç®—æ³•</div>
                <button class="btn btn-primary" onclick="game.showBankerAlgorithm()">
                    æŸ¥çœ‹ç®—æ³•æ¼”ç¤º
                </button>
            </div>
        </div>
    </div>

    <!-- API å®¢æˆ·ç«¯ -->
    <script src="../../common/api-client.js"></script>

    <script>
        // æ­»é”å¤„ç†æ¸¸æˆä¸»ç±»
        class DeadlockGame {
            constructor() {
                this.strategy = 'prevention';
                this.processes = [];
                this.resources = [];
                this.isRunning = false;
                this.isDeadlocked = false;

                // é»˜è®¤æ•°æ®
                this.defaultProcesses = [
                    {
                        id: 'P1',
                        name: 'æ‘æ°‘A',
                        held: [],
                        waiting: 'R2',
                        status: 'waiting',
                        color: '#e74c3c'
                    },
                    {
                        id: 'P2',
                        name: 'æ‘æ°‘B',
                        held: ['R2'],
                        waiting: 'R3',
                        status: 'waiting',
                        color: '#3498db'
                    },
                    {
                        id: 'P3',
                        name: 'æ‘æ°‘C',
                        held: ['R3'],
                        waiting: 'R1',
                        status: 'waiting',
                        color: '#2ecc71'
                    },
                    {
                        id: 'P4',
                        name: 'æ‘æ°‘D',
                        held: ['R1'],
                        waiting: 'R2',
                        status: 'waiting',
                        color: '#f39c12'
                    }
                ];

                this.defaultResources = [
                    { id: 'R1', name: 'æ°´äº•', holder: 'P4' },
                    { id: 'R2', name: 'å†œå…·', holder: 'P2' },
                    { id: 'R3', name: 'ä»“åº“', holder: 'P3' }
                ];
            }

            init() {
                this.processes = JSON.parse(JSON.stringify(this.defaultProcesses));
                this.resources = JSON.parse(JSON.stringify(this.defaultResources));
                this.isDeadlocked = false;
                this.updateDisplay();
                this.updateStrategyInfo();
                document.getElementById('deadlockIndicator').style.display = 'none';
            }

            setStrategy(strategy) {
                this.strategy = strategy;
                document.querySelectorAll('.strategy-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                this.updateStrategyInfo();
                this.resetSimulation();
            }

            updateStrategyInfo() {
                const info = {
                    'prevention': '<strong>æ­»é”é¢„é˜²</strong><br>é€šè¿‡ç ´åæ­»é”å››ä¸ªå¿…è¦æ¡ä»¶ä¸­çš„è‡³å°‘ä¸€ä¸ªæ¥é¢„é˜²æ­»é”ã€‚å¸¸ç”¨æ–¹æ³•ï¼šèµ„æºä¸€æ¬¡æ€§åˆ†é…ã€å…è®¸èµ„æºæŠ¢å ã€æœ‰åºèµ„æºåˆ†é…ã€‚',
                    'avoidance': '<strong>æ­»é”é¿å…</strong><br>åœ¨è¿›ç¨‹è¿è¡Œæ—¶åŠ¨æ€æ£€æŸ¥èµ„æºåˆ†é…ï¼Œç¡®ä¿ç³»ç»Ÿå§‹ç»ˆå¤„äºå®‰å…¨çŠ¶æ€ã€‚é“¶è¡Œå®¶ç®—æ³•æ˜¯å…¸å‹çš„æ­»é”é¿å…ç®—æ³•ã€‚',
                    'detection': '<strong>æ­»é”æ£€æµ‹</strong><br>å…è®¸ç³»ç»Ÿè¿›å…¥æ­»é”çŠ¶æ€ï¼Œç„¶åå®šæœŸæ£€æµ‹æ˜¯å¦å‘ç”Ÿæ­»é”ã€‚å¦‚æœæ£€æµ‹åˆ°æ­»é”ï¼Œåˆ™é‡‡å–æªæ–½è§£é™¤ã€‚',
                    'recovery': '<strong>æ­»é”æ¢å¤</strong><br>å½“æ£€æµ‹åˆ°æ­»é”åï¼Œé‡‡å–æªæ–½è§£é™¤æ­»é”ã€‚æ–¹æ³•åŒ…æ‹¬ï¼šæŠ¢å èµ„æºã€ç»ˆæ­¢è¿›ç¨‹ã€å›æ»šæ“ä½œç­‰ã€‚'
                };
                document.getElementById('strategyInfo').innerHTML = info[this.strategy];
            }

            updateDisplay() {
                // æ›´æ–°èµ„æºæ± 
                const resourcePool = document.getElementById('resourcePool');
                resourcePool.innerHTML = '';
                this.resources.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'resource-item';
                    div.innerHTML = `<strong>${r.name}</strong> (${r.id})<br>æŒæœ‰è€…: ${r.holder || 'ç©ºé—²'}`;
                    resourcePool.appendChild(div);
                });

                // æ›´æ–°è¿›ç¨‹å®¹å™¨
                const processContainer = document.getElementById('processContainer');
                processContainer.innerHTML = '';
                this.processes.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'process-item' + (p.status === 'deadlocked' ? ' deadlocked' : '');
                    div.innerHTML = `
                        <div><strong>${p.name}</strong> (${p.id})</div>
                        <div style="font-size: 12px; margin-top: 5px;">
                            æŒæœ‰: ${p.held.length > 0 ? p.held.join(', ') : 'æ— '}<br>
                            ç­‰å¾…: ${p.waiting || 'æ— '}
                        </div>
                    `;
                    processContainer.appendChild(div);
                });

                // æ›´æ–°èµ„æºåˆ†é…è¡¨
                const table = document.getElementById('allocationTable');
                table.innerHTML = '';
                this.processes.forEach(p => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${p.name}</strong></td>
                        <td>${p.held.map(r => `<span class="held">${r}</span>`).join('') || '-'}</td>
                        <td>${p.waiting ? `<span class="waiting">${p.waiting}</span>` : '-'}</td>
                        <td>${p.status === 'deadlocked' ? 'â›” æ­»é”' : p.status === 'running' ? 'âœ… è¿è¡Œ' : 'â³ ç­‰å¾…'}</td>
                    `;
                    table.appendChild(row);
                });

                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('totalProcesses').textContent = this.processes.length;
                document.getElementById('totalResources').textContent = this.resources.length;
                document.getElementById('waitingProcesses').textContent =
                    this.processes.filter(p => p.status === 'waiting').length;
                document.getElementById('deadlockStatus').textContent = this.isDeadlocked ? 'â›” æ­»é”' : 'âœ… æ­£å¸¸';
                document.getElementById('deadlockStatus').style.color = this.isDeadlocked ? '#e74c3c' : '#27ae60';
            }

            startSimulation() {
                if (this.isRunning) return;
                this.isRunning = true;

                // æ¨¡æ‹Ÿè¿›ç¨‹è¯·æ±‚èµ„æº
                this.processes.forEach((p, index) => {
                    setTimeout(() => {
                        this.showProcessAction(p);
                    }, index * 1000);
                });

                setTimeout(() => {
                    this.isRunning = false;
                    this.detectDeadlock();
                }, this.processes.length * 1000);
            }

            showProcessAction(process) {
                const dialog = document.getElementById('uncleDialog');
                dialog.innerHTML = `ğŸ‘´ å­—èŠ‚å”<br>${process.name} æ­£åœ¨ç­‰å¾…èµ„æº ${process.waiting}...<br>å½“å‰æŒæœ‰: ${process.held.length > 0 ? process.held.join(', ') : 'æ— '}`;
            }

            detectDeadlock() {
                // æ£€æµ‹å¾ªç¯ç­‰å¾…
                const visited = new Set();
                const recStack = new Set();
                let hasCycle = false;

                const dfs = (processId) => {
                    if (recStack.has(processId)) {
                        return true;
                    }
                    if (visited.has(processId)) {
                        return false;
                    }

                    visited.add(processId);
                    recStack.add(processId);

                    const process = this.processes.find(p => p.id === processId);
                    if (process && process.waiting) {
                        // æ‰¾åˆ°æŒæœ‰ç­‰å¾…èµ„æºçš„è¿›ç¨‹
                        const nextProcess = this.processes.find(p => p.held.includes(process.waiting));
                        if (nextProcess && dfs(nextProcess.id)) {
                            return true;
                        }
                    }

                    recStack.delete(processId);
                    return false;
                };

                for (const p of this.processes) {
                    if (dfs(p.id)) {
                        hasCycle = true;
                        break;
                    }
                }

                this.isDeadlocked = hasCycle;

                if (hasCycle) {
                    document.getElementById('deadlockIndicator').style.display = 'block';
                    this.processes.forEach(p => {
                        if (p.waiting) p.status = 'deadlocked';
                    });
                    document.getElementById('uncleDialog').innerHTML =
                        'ğŸ‘´ å­—èŠ‚å”<br>âš ï¸ æ£€æµ‹åˆ°æ­»é”ï¼<br>è¿›ç¨‹ä¹‹é—´å½¢æˆäº†å¾ªç¯ç­‰å¾…é“¾ï¼šP1â†’P2â†’P3â†’P4â†’P1<br>éœ€è¦é‡‡å–æªæ–½è§£é™¤æ­»é”ï¼';
                } else {
                    document.getElementById('deadlockIndicator').style.display = 'none';
                    document.getElementById('uncleDialog').innerHTML =
                        'ğŸ‘´ å­—èŠ‚å”<br>âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼<br>æ²¡æœ‰æ£€æµ‹åˆ°æ­»é”ã€‚';
                }

                this.updateDisplay();
            }

            resolveDeadlock() {
                if (!this.isDeadlocked) {
                    document.getElementById('uncleDialog').innerHTML =
                        'ğŸ‘´ å­—èŠ‚å”<br>å½“å‰æ²¡æœ‰æ­»é”ï¼Œä¸éœ€è¦è§£é™¤ï¼';
                    return;
                }

                // ç®€å•çš„æ­»é”æ¢å¤ï¼šé‡Šæ”¾ç¬¬ä¸€ä¸ªç­‰å¾…è¿›ç¨‹çš„èµ„æº
                const process = this.processes.find(p => p.status === 'deadlocked');
                if (process && process.held.length > 0) {
                    const releasedResource = process.held.shift();
                    const resource = this.resources.find(r => r.id === releasedResource);
                    if (resource) {
                        resource.holder = null;
                    }

                    // æ£€æŸ¥æ˜¯å¦æœ‰è¿›ç¨‹åœ¨ç­‰å¾…è¿™ä¸ªèµ„æº
                    const waitingProcess = this.processes.find(p => p.waiting === releasedResource);
                    if (waitingProcess) {
                        waitingProcess.held.push(releasedResource);
                        waitingProcess.waiting = null;
                        waitingProcess.status = 'running';
                        const res = this.resources.find(r => r.id === releasedResource);
                        if (res) res.holder = waitingProcess.id;
                    }

                    process.status = 'running';
                }

                // é‡æ–°æ£€æµ‹æ­»é”
                this.detectDeadlock();

                if (!this.isDeadlocked) {
                    document.getElementById('uncleDialog').innerHTML =
                        'ğŸ‘´ å­—èŠ‚å”<br>âœ… æ­»é”å·²è§£é™¤ï¼<br>é€šè¿‡èµ„æºæŠ¢å ï¼ŒæˆåŠŸæ‰“ç ´äº†å¾ªç¯ç­‰å¾…é“¾ã€‚';
                }
            }

            resetSimulation() {
                this.isRunning = false;
                this.init();
            }

            showBankerAlgorithm() {
                document.getElementById('uncleDialog').innerHTML =
                    'ğŸ‘´ å­—èŠ‚å”<br>ğŸ¦ é“¶è¡Œå®¶ç®—æ³•ç®€ä»‹<br><br>' +
                    'é“¶è¡Œå®¶ç®—æ³•æ˜¯ä¸€ç§æ­»é”é¿å…ç®—æ³•ï¼Œå…¶æ€æƒ³æ˜¯ï¼š<br>' +
                    '1. è¿›ç¨‹ç”³è¯·èµ„æºæ—¶ï¼Œå…ˆåˆ¤æ–­åˆ†é…åç³»ç»Ÿæ˜¯å¦å®‰å…¨<br>' +
                    '2. å¦‚æœå®‰å…¨ï¼Œåˆ™åˆ†é…ï¼›å¦åˆ™æ¨è¿Ÿåˆ†é…<br>' +
                    '3. å®‰å…¨çŠ¶æ€æŒ‡å­˜åœ¨ä¸€ä¸ªå®‰å…¨åºåˆ—ï¼Œä½¿æ‰€æœ‰è¿›ç¨‹éƒ½èƒ½å®Œæˆ<br><br>' +
                    'æ¨¡æ‹Ÿå™¨ä¸­çš„ç®€åŒ–ç‰ˆæœ¬ï¼šç¡®ä¿åˆ†é…åè‡³å°‘æœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½è·å¾—æ‰€æœ‰æ‰€éœ€èµ„æºå¹¶å®Œæˆã€‚';
            }

            async showHint() {
                try {
                    const hint = await OS_VILLAGE_API.getHint(
                        'session_' + Date.now(),
                        {
                            game: 'deadlock',
                            strategy: this.strategy,
                            stage: 'learning'
                        }
                    );
                    document.getElementById('uncleDialog').innerHTML =
                        'ğŸ‘´ å­—èŠ‚å”<br>' + hint.hint;
                } catch (error) {
                    this.getOfflineHint();
                }
            }

            getOfflineHint() {
                const hints = {
                    'prevention': 'ç ´åå››ä¸ªæ¡ä»¶ä¹‹ä¸€ï¼æ¯”å¦‚è®©è¿›ç¨‹ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æºï¼Œæˆ–è€…å…è®¸èµ„æºæŠ¢å ã€‚',
                    'avoidance': 'ä½¿ç”¨é“¶è¡Œå®¶ç®—æ³•ï¼åˆ†é…å‰å…ˆæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å¤„äºå®‰å…¨çŠ¶æ€ã€‚',
                    'detection': 'ä½¿ç”¨èµ„æºåˆ†é…å›¾ï¼å¦‚æœå›¾ä¸­å­˜åœ¨ç¯è·¯ï¼Œå°±å¯èƒ½å‘ç”Ÿæ­»é”ã€‚',
                    'recovery': 'å¯ä»¥æŠ¢å èµ„æºæˆ–ç»ˆæ­¢è¿›ç¨‹ï¼é€‰æ‹©ä»£ä»·æœ€å°çš„æ–¹æ³•ã€‚'
                };
                document.getElementById('uncleDialog').innerHTML =
                    'ğŸ‘´ å­—èŠ‚å”<br>' + hints[this.strategy];
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        const game = new DeadlockGame();
        game.init();
    </script>
</body>
</html>
