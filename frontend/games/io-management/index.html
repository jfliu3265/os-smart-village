<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©èµ„è¿è¾“é˜Ÿ - I/Oç®¡ç†å­¦ä¹ </title>
    <link rel="stylesheet" href="../../styles/main.css">
    <style>
        .game-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .game-area {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .side-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .tech-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: 2px solid #9b59b6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tech-btn:hover {
            background: #9b59b6;
            color: white;
            transform: translateX(5px);
        }

        .tech-btn.active {
            background: #9b59b6;
            color: white;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #9b59b6;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .io-diagram {
            background: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            min-height: 300px;
        }

        .component {
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            position: absolute;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .component:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .cpu {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
        }

        .memory {
            top: 120px;
            left: 10%;
            width: 120px;
        }

        .io-controller {
            top: 120px;
            right: 10%;
            width: 120px;
        }

        .device {
            top: 250px;
            right: 10%;
            width: 120px;
        }

        .buffer {
            top: 250px;
            left: 10%;
            width: 120px;
        }

        .data-flow {
            position: absolute;
            height: 3px;
            background: #3498db;
            transform-origin: left center;
            animation: flow 1s infinite;
        }

        @keyframes flow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .uncle-dialog {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            position: relative;
        }

        .uncle-dialog::before {
            content: 'ğŸ‘´ å­—èŠ‚å”';
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #856404;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .interrupt-indicator {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            display: none;
            animation: flash 0.5s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .buffer-visual {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .buffer-slot {
            width: 40px;
            height: 40px;
            border: 2px solid #3498db;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            font-size: 12px;
            transition: all 0.3s;
        }

        .buffer-slot.filled {
            background: #27ae60;
            color: white;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .comparison-table th {
            background: #9b59b6;
            color: white;
        }

        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .queue-visual {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }

        .queue-item {
            background: #3498db;
            color: white;
            padding: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- è¿”å›æŒ‰é’® -->
    <button class="back-btn btn btn-primary" onclick="window.location.href='../../index.html'">
        â† è¿”å›æ‘åº„
    </button>

    <div class="game-container">
        <!-- æ¸¸æˆä¸»åŒºåŸŸ -->
        <div class="game-area">
            <h1 style="text-align: center; margin-bottom: 20px;">
                ğŸšš ç‰©èµ„è¿è¾“é˜Ÿ - I/Oç®¡ç†å­¦ä¹ 
            </h1>

            <!-- ä¸­æ–­æŒ‡ç¤ºå™¨ -->
            <div id="interruptIndicator" class="interrupt-indicator">
                ğŸ“¡ I/Oä¸­æ–­è¯·æ±‚ï¼CPUæ­£åœ¨å¤„ç†...
            </div>

            <!-- I/Oç³»ç»Ÿå›¾ -->
            <div class="io-diagram">
                <div class="component cpu">
                    <strong>CPU</strong><br>
                    <span id="cpuStatus">ç©ºé—²</span>
                </div>
                <div class="component memory">
                    <strong>å†…å­˜</strong><br>
                    <span id="memoryStatus">æ— æ•°æ®</span>
                </div>
                <div class="component io-controller">
                    <strong>I/Oæ§åˆ¶å™¨</strong><br>
                    <span id="ioStatus">ç©ºé—²</span>
                </div>
                <div class="component device">
                    <strong>I/Oè®¾å¤‡</strong><br>
                    <span id="deviceStatus">ç©ºé—²</span>
                </div>
                <div class="component buffer">
                    <strong>ç¼“å†²åŒº</strong><br>
                    <div id="bufferVisual" class="buffer-visual">
                        <div class="buffer-slot"></div>
                        <div class="buffer-slot"></div>
                        <div class="buffer-slot"></div>
                        <div class="buffer-slot"></div>
                    </div>
                </div>

                <!-- æ•°æ®æµç®­å¤´ -->
                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#3498db" />
                        </marker>
                    </defs>
                    <line x1="50%" y1="80" x2="50%" y2="110" stroke="#3498db" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="20%" y1="180" x2="20%" y2="240" stroke="#3498db" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="80%" y1="180" x2="80%" y2="240" stroke="#3498db" stroke-width="2" marker-end="url(#arrowhead)" />
                </svg>
            </div>

            <!-- I/Oè¯·æ±‚é˜Ÿåˆ— -->
            <h3>ğŸ“‹ I/Oè¯·æ±‚é˜Ÿåˆ—</h3>
            <div id="ioQueue" class="queue-visual">
                <!-- é˜Ÿåˆ—é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="game.startIO()">â–¶ å‘èµ·I/Oè¯·æ±‚</button>
                <button class="btn btn-success" onclick="game.enableInterrupt()">ğŸ”” å¯ç”¨ä¸­æ–­</button>
                <button class="btn btn-warning" onclick="game.useDMA()">ğŸš€ ä½¿ç”¨DMA</button>
                <button class="btn btn-primary" onclick="game.resetSimulation()">â†» é‡ç½®</button>
            </div>

            <!-- å­—èŠ‚å”å¯¹è¯æ¡† -->
            <div class="uncle-dialog" id="uncleDialog">
                æ¬¢è¿æ¥åˆ°ç‰©èµ„è¿è¾“é˜Ÿï¼æˆ‘æ˜¯å­—èŠ‚å”ã€‚
                åœ¨è¿™é‡Œï¼Œä½ å°†å­¦ä¹ I/Oç³»ç»Ÿçš„å·¥ä½œåŸç†ï¼ŒåŒ…æ‹¬ä¸­æ–­ã€ç¼“å†²ã€DMAç­‰æŠ€æœ¯ã€‚
                è¿™äº›æŠ€æœ¯è®©CPUå’ŒI/Oè®¾å¤‡èƒ½å¤Ÿé«˜æ•ˆåä½œï¼
            </div>
        </div>

        <!-- ä¾§è¾¹é¢æ¿ -->
        <div class="side-panel">
            <!-- I/OæŠ€æœ¯é€‰æ‹© -->
            <div class="panel-card">
                <div class="panel-title">âš™ï¸ I/OæŠ€æœ¯</div>
                <button class="tech-btn active" onclick="game.setTechnique('polling')">
                    è½®è¯¢æ–¹å¼
                </button>
                <button class="tech-btn" onclick="game.setTechnique('interrupt')">
                    ä¸­æ–­æ–¹å¼
                </button>
                <button class="tech-btn" onclick="game.setTechnique('dma')">
                    DMAæ–¹å¼
                </button>
                <button class="tech-btn" onclick="game.setTechnique('channel')">
                    é€šé“æ–¹å¼
                </button>
            </div>

            <!-- æŠ€æœ¯å¯¹æ¯” -->
            <div class="panel-card">
                <div class="panel-title">ğŸ“Š I/Oæ–¹å¼å¯¹æ¯”</div>
                <table class="comparison-table">
                    <tr>
                        <th>æ–¹å¼</th>
                        <th>CPUæ•ˆç‡</th>
                    </tr>
                    <tr>
                        <td>è½®è¯¢</td>
                        <td>â­</td>
                    </tr>
                    <tr>
                        <td>ä¸­æ–­</td>
                        <td>â­â­â­</td>
                    </tr>
                    <tr>
                        <td>DMA</td>
                        <td>â­â­â­â­</td>
                    </tr>
                    <tr>
                        <td>é€šé“</td>
                        <td>â­â­â­â­â­</td>
                    </tr>
                </table>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="panel-card">
                <div class="panel-title">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">I/Oè¯·æ±‚æ•°</div>
                        <div class="stat-value" id="totalRequests">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å·²å®Œæˆ</div>
                        <div class="stat-value" id="completedRequests">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">CPUåˆ©ç”¨ç‡</div>
                        <div class="stat-value" id="cpuUtilization">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ä¸­æ–­æ¬¡æ•°</div>
                        <div class="stat-value" id="interruptCount">0</div>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯è¯´æ˜ -->
            <div class="panel-card">
                <div class="panel-title">ğŸ“– æŠ€æœ¯è¯´æ˜</div>
                <div class="info-box" id="techniqueInfo">
                    <strong>è½®è¯¢æ–¹å¼</strong><br>
                    CPUå®šæœŸæ£€æŸ¥I/Oè®¾å¤‡çŠ¶æ€ï¼Œå°±åƒä¸æ–­æŸ¥çœ‹ä¿¡ç®±æ˜¯å¦æœ‰é‚®ä»¶ã€‚
                    ä¼˜ç‚¹æ˜¯ç®€å•ï¼Œç¼ºç‚¹æ˜¯æµªè´¹CPUæ—¶é—´ã€‚
                </div>
            </div>

            <!-- SpoolingæŠ€æœ¯ -->
            <div class="panel-card">
                <div class="panel-title">ğŸ–¨ï¸ SpoolingæŠ€æœ¯</div>
                <button class="btn btn-primary" onclick="game.showSpooling()">
                    äº†è§£Spooling
                </button>
            </div>
        </div>
    </div>

    <!-- API å®¢æˆ·ç«¯ -->
    <script src="../../common/api-client.js"></script>

    <script>
        // I/Oç®¡ç†æ¸¸æˆä¸»ç±»
        class IOManagementGame {
            constructor() {
                this.technique = 'polling';
                this.ioQueue = [];
                this.completedCount = 0;
                this.totalRequests = 0;
                this.interruptCount = 0;
                this.interruptEnabled = false;
                this.dmaEnabled = false;
                this.isProcessing = false;

                // ç¼“å†²åŒºæ•°æ®
                this.buffer = [null, null, null, null];
            }

            init() {
                this.ioQueue = [];
                this.completedCount = 0;
                this.totalRequests = 0;
                this.interruptCount = 0;
                this.interruptEnabled = false;
                this.dmaEnabled = false;
                this.isProcessing = false;
                this.buffer = [null, null, null, null];

                this.updateDisplay();
                this.updateTechniqueInfo();
            }

            setTechnique(tech) {
                this.technique = tech;
                document.querySelectorAll('.tech-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                this.resetSimulation();
                this.updateTechniqueInfo();
            }

            updateTechniqueInfo() {
                const info = {
                    'polling': '<strong>è½®è¯¢æ–¹å¼</strong><br>CPUå®šæœŸæ£€æŸ¥I/Oè®¾å¤‡çŠ¶æ€ï¼Œå°±åƒä¸æ–­æŸ¥çœ‹ä¿¡ç®±æ˜¯å¦æœ‰é‚®ä»¶ã€‚ä¼˜ç‚¹æ˜¯ç®€å•ï¼Œç¼ºç‚¹æ˜¯æµªè´¹CPUæ—¶é—´ã€‚',
                    'interrupt': '<strong>ä¸­æ–­æ–¹å¼</strong><br>I/Oè®¾å¤‡å®Œæˆæ“ä½œåå‘CPUå‘é€ä¸­æ–­ä¿¡å·ï¼ŒCPUæš‚åœå½“å‰ç¨‹åºå¤„ç†ä¸­æ–­ã€‚æ•ˆç‡é«˜ï¼Œæ˜¯ç°ä»£OSçš„ä¸»è¦æ–¹å¼ã€‚',
                    'dma': '<strong>DMAæ–¹å¼</strong><br>ç›´æ¥å†…å­˜è®¿é—®ï¼ŒDMAæ§åˆ¶å™¨æ§åˆ¶æ•°æ®åœ¨å†…å­˜å’ŒI/Oè®¾å¤‡é—´ä¼ è¾“ï¼Œæ— éœ€CPUå¹²é¢„ã€‚é€‚ç”¨äºå¤§æ‰¹é‡æ•°æ®ä¼ è¾“ã€‚',
                    'channel': '<strong>é€šé“æ–¹å¼</strong><br>é€šé“æ˜¯ç‹¬ç«‹çš„å¤„ç†å™¨ï¼Œå¯ä»¥æ‰§è¡ŒI/Oç¨‹åºã€‚CPUåªéœ€å‘å‡ºI/OæŒ‡ä»¤ï¼Œé€šé“å®Œæˆæ‰€æœ‰I/Oæ“ä½œã€‚æ•ˆç‡æœ€é«˜ã€‚'
                };
                document.getElementById('techniqueInfo').innerHTML = info[this.technique];
            }

            updateDisplay() {
                // æ›´æ–°I/Oé˜Ÿåˆ—
                const queueDiv = document.getElementById('ioQueue');
                queueDiv.innerHTML = '';

                if (this.ioQueue.length === 0) {
                    queueDiv.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 10px;">é˜Ÿåˆ—ä¸ºç©º</div>';
                } else {
                    this.ioQueue.forEach((req, index) => {
                        const item = document.createElement('div');
                        item.className = 'queue-item';
                        item.innerHTML = `
                            <span>${index + 1}. ${req.type} - ${req.data}</span>
                            <span>${req.status}</span>
                        `;
                        queueDiv.appendChild(item);
                    });
                }

                // æ›´æ–°ç¼“å†²åŒº
                const bufferVisual = document.getElementById('bufferVisual');
                bufferVisual.innerHTML = '';
                this.buffer.forEach((data, index) => {
                    const slot = document.createElement('div');
                    slot.className = 'buffer-slot' + (data ? ' filled' : '');
                    slot.textContent = data || '';
                    bufferVisual.appendChild(slot);
                });

                // æ›´æ–°çŠ¶æ€
                document.getElementById('cpuStatus').textContent = this.isProcessing ? 'å¤„ç†ä¸­' : 'ç©ºé—²';
                document.getElementById('memoryStatus').textContent = this.buffer.filter(b => b).length + '/4';
                document.getElementById('ioStatus').textContent = this.ioQueue.length > 0 ? 'å¿™ç¢Œ' : 'ç©ºé—²';
                document.getElementById('deviceStatus').textContent = this.isProcessing ? 'ä¼ è¾“ä¸­' : 'ç©ºé—²';

                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('totalRequests').textContent = this.totalRequests;
                document.getElementById('completedRequests').textContent = this.completedCount;
                const cpuUtil = this.technique === 'polling' ? 20 :
                                this.technique === 'interrupt' ? 80 :
                                this.technique === 'dma' ? 95 : 99;
                document.getElementById('cpuUtilization').textContent = cpuUtil + '%';
                document.getElementById('interruptCount').textContent = this.interruptCount;
            }

            startIO() {
                if (this.isProcessing && this.technique === 'polling') {
                    document.getElementById('uncleDialog').innerHTML =
                        'ğŸ‘´ å­—èŠ‚å”<br>å½“å‰æ­£åœ¨å¤„ç†I/Oè¯·æ±‚ï¼Œè¯·ç­‰å¾…å®Œæˆæˆ–ä½¿ç”¨ä¸­æ–­/DMAæ–¹å¼ï¼';
                    return;
                }

                const requestData = ['æ•°æ®å—1', 'æ•°æ®å—2', 'æ•°æ®å—3', 'æ•°æ®å—4'][Math.floor(Math.random() * 4)];
                const request = {
                    id: Date.now(),
                    type: 'è¯»æ“ä½œ',
                    data: requestData,
                    status: 'ç­‰å¾…ä¸­'
                };

                this.ioQueue.push(request);
                this.totalRequests++;

                document.getElementById('uncleDialog').innerHTML =
                    `ğŸ‘´ å­—èŠ‚å”<br>æ–°çš„I/Oè¯·æ±‚å·²åŠ å…¥é˜Ÿåˆ—ï¼š${request.data}<br>å½“å‰æŠ€æœ¯ï¼š${this.getTechniqueName()}`;

                this.processIO();
            }

            processIO() {
                if (this.isProcessing || this.ioQueue.length === 0) return;

                const request = this.ioQueue[0];
                request.status = 'å¤„ç†ä¸­';
                this.isProcessing = true;

                switch (this.technique) {
                    case 'polling':
                        this.processPolling(request);
                        break;
                    case 'interrupt':
                        this.processInterrupt(request);
                        break;
                    case 'dma':
                        this.processDMA(request);
                        break;
                    case 'channel':
                        this.processChannel(request);
                        break;
                }

                this.updateDisplay();
            }

            processPolling(request) {
                document.getElementById('uncleDialog').innerHTML =
                    'ğŸ‘´ å­—èŠ‚å”<br>ä½¿ç”¨è½®è¯¢æ–¹å¼ï¼šCPUå¿…é¡»ä¸æ–­æ£€æŸ¥I/Oè®¾å¤‡çŠ¶æ€...<br>CPUè¢«å ç”¨ï¼Œæ•ˆç‡è¾ƒä½ï¼';

                setTimeout(() => {
                    this.completeIO(request);
                }, 2000);
            }

            processInterrupt(request) {
                if (!this.interruptEnabled) {
                    document.getElementById('uncleDialog').innerHTML =
                        'ğŸ‘´ å­—èŠ‚å”<br>ä¸­æ–­æ–¹å¼éœ€è¦å…ˆå¯ç”¨ä¸­æ–­åŠŸèƒ½ï¼<br>è¯·ç‚¹å‡»"å¯ç”¨ä¸­æ–­"æŒ‰é’®ã€‚';
                    request.status = 'ç­‰å¾…ä¸­æ–­';
                    this.isProcessing = false;
                    this.updateDisplay();
                    return;
                }

                document.getElementById('uncleDialog').innerHTML =
                    'ğŸ‘´ å­—èŠ‚å”<br>ä½¿ç”¨ä¸­æ–­æ–¹å¼ï¼šCPUå¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œ<br>I/Oå®Œæˆæ—¶ä¼šå‘é€ä¸­æ–­ä¿¡å·ï¼';

                document.getElementById('interruptIndicator').style.display = 'block';

                setTimeout(() => {
                    document.getElementById('interruptIndicator').style.display = 'none';
                    this.interruptCount++;
                    this.completeIO(request);
                }, 1000);
            }

            processDMA(request) {
                if (!this.dmaEnabled) {
                    document.getElementById('uncleDialog').innerHTML =
                        'ğŸ‘´ å­—èŠ‚å”<br>DMAæ–¹å¼éœ€è¦å…ˆå¯ç”¨DMAï¼<br>è¯·ç‚¹å‡»"ä½¿ç”¨DMA"æŒ‰é’®ã€‚';
                    request.status = 'ç­‰å¾…DMA';
                    this.isProcessing = false;
                    this.updateDisplay();
                    return;
                }

                document.getElementById('uncleDialog').innerHTML =
                    'ğŸ‘´ å­—èŠ‚å”<br>ä½¿ç”¨DMAæ–¹å¼ï¼šDMAæ§åˆ¶å™¨ç›´æ¥ä¼ è¾“æ•°æ®ï¼Œ<br>CPUå‡ ä¹ä¸éœ€è¦å¹²é¢„ï¼';

                setTimeout(() => {
                    this.interruptCount++; // DMAå®Œæˆæ—¶çš„ä¸­æ–­
                    this.completeIO(request);
                }, 500);
            }

            processChannel(request) {
                document.getElementById('uncleDialog').innerHTML =
                    'ğŸ‘´ å­—èŠ‚å”<br>ä½¿ç”¨é€šé“æ–¹å¼ï¼šI/Oé€šé“ç‹¬ç«‹å®Œæˆæ‰€æœ‰æ“ä½œï¼Œ<br>CPUæ•ˆç‡æœ€é«˜ï¼';

                setTimeout(() => {
                    this.completeIO(request);
                }, 300);
            }

            completeIO(request) {
                // å°†æ•°æ®æ”¾å…¥ç¼“å†²åŒº
                const emptySlot = this.buffer.findIndex(b => b === null);
                if (emptySlot !== -1) {
                    this.buffer[emptySlot] = request.data;
                }

                // ä»é˜Ÿåˆ—ä¸­ç§»é™¤
                this.ioQueue.shift();
                this.completedCount++;
                this.isProcessing = false;

                document.getElementById('uncleDialog').innerHTML =
                    `ğŸ‘´ å­—èŠ‚å”<br>âœ… I/Oæ“ä½œå®Œæˆï¼${request.data} å·²ä¼ è¾“åˆ°ç¼“å†²åŒºã€‚`;

                this.updateDisplay();

                // ç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªè¯·æ±‚
                if (this.ioQueue.length > 0) {
                    setTimeout(() => this.processIO(), 500);
                }
            }

            enableInterrupt() {
                this.interruptEnabled = !this.interruptEnabled;
                const btn = event.target;
                if (this.interruptEnabled) {
                    btn.textContent = 'ğŸ”” ç¦ç”¨ä¸­æ–­';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-warning');
                } else {
                    btn.textContent = 'ğŸ”” å¯ç”¨ä¸­æ–­';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-success');
                }

                document.getElementById('uncleDialog').innerHTML =
                    `ğŸ‘´ å­—èŠ‚å”<br>ä¸­æ–­å·²${this.interruptEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}ï¼<br>
                    ${this.interruptEnabled ? 'ç°åœ¨I/Oè®¾å¤‡å®Œæˆæ“ä½œåä¼šä¸»åŠ¨é€šçŸ¥CPUã€‚' : 'CPUå°†ä½¿ç”¨è½®è¯¢æ–¹å¼æ£€æŸ¥I/OçŠ¶æ€ã€‚'}`;
            }

            useDMA() {
                this.dmaEnabled = !this.dmaEnabled;
                const btn = event.target;
                if (this.dmaEnabled) {
                    btn.textContent = 'ğŸš€ ç¦ç”¨DMA';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-success');
                } else {
                    btn.textContent = 'ğŸš€ ä½¿ç”¨DMA';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-warning');
                }

                document.getElementById('uncleDialog').innerHTML =
                    `ğŸ‘´ å­—èŠ‚å”<br>DMAå·²${this.dmaEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}ï¼<br>
                    ${this.dmaEnabled ? 'æ•°æ®ä¼ è¾“ä¸å†å ç”¨CPUæ—¶é—´ã€‚' : 'æ¢å¤åˆ°ä¸­æ–­æ–¹å¼ã€‚'}`;
            }

            resetSimulation() {
                this.init();
                document.getElementById('uncleDialog').innerHTML =
                    'ğŸ‘´ å­—èŠ‚å”<br>æ¨¡æ‹Ÿå·²é‡ç½®ï¼é€‰æ‹©ä¸€ç§I/OæŠ€æœ¯å¼€å§‹å­¦ä¹ å§ã€‚';
            }

            getTechniqueName() {
                const names = {
                    'polling': 'è½®è¯¢',
                    'interrupt': 'ä¸­æ–­',
                    'dma': 'DMA',
                    'channel': 'é€šé“'
                };
                return names[this.technique];
            }

            showSpooling() {
                document.getElementById('uncleDialog').innerHTML =
                    'ğŸ‘´ å­—èŠ‚å”<br>ğŸ–¨ï¸ SpoolingæŠ€æœ¯ç®€ä»‹<br><br>' +
                    '<strong>S</strong>imultaneous <strong>P</strong>eripheral <strong>O</strong>perations <strong>O</strong>nline<br><br>' +
                    'Spoolingï¼ˆå‡è„±æœºï¼‰æŠ€æœ¯ï¼š<br>' +
                    '1. å°†ç‹¬å è®¾å¤‡æ”¹é€ æˆå…±äº«è®¾å¤‡<br>' +
                    '2. è¾“å…¥/è¾“å‡ºæ•°æ®å…ˆå­˜å…¥ç£ç›˜<br>' +
                    '3. æé«˜è®¾å¤‡åˆ©ç”¨ç‡ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´<br><br>' +
                    '<strong>å…¸å‹åº”ç”¨ï¼š</strong>æ‰“å°ç³»ç»Ÿ<br>' +
                    'å¤šç”¨æˆ·å¯åŒæ—¶"æ‰“å°"ï¼Œç³»ç»Ÿå°†æ‰“å°ä»»åŠ¡æ’å…¥é˜Ÿåˆ—ï¼Œä¾æ¬¡å¤„ç†ã€‚';
            }

            async showHint() {
                try {
                    const hint = await OS_VILLAGE_API.getHint(
                        'session_' + Date.now(),
                        {
                            game: 'io-management',
                            technique: this.technique,
                            stage: 'learning'
                        }
                    );
                    document.getElementById('uncleDialog').innerHTML =
                        'ğŸ‘´ å­—èŠ‚å”<br>' + hint.hint;
                } catch (error) {
                    this.getOfflineHint();
                }
            }

            getOfflineHint() {
                const hints = {
                    'polling': 'è½®è¯¢å°±åƒä¸æ–­æŸ¥çœ‹ä¿¡ç®±ï¼Œæµªè´¹CPUæ—¶é—´ã€‚åº”è¯¥å‡çº§åˆ°ä¸­æ–­æ–¹å¼ï¼',
                    'interrupt': 'ä¸­æ–­æ–¹å¼æ•ˆç‡é«˜ï¼I/Oå®Œæˆæ—¶ä¼šé€šçŸ¥CPUï¼ŒCPUå¯ä»¥åšå…¶ä»–äº‹æƒ…ã€‚',
                    'dma': 'DMAæ–¹å¼é€‚åˆå¤§é‡æ•°æ®ä¼ è¾“ï¼æ•°æ®ç›´æ¥åœ¨å†…å­˜å’Œè®¾å¤‡é—´ä¼ è¾“ã€‚',
                    'channel': 'é€šé“æ˜¯æœ€å…ˆè¿›çš„ï¼å®ƒåƒä¸€ä¸ªç‹¬ç«‹çš„å¤„ç†å™¨ï¼Œå®Œå…¨æ¥ç®¡I/Oæ“ä½œã€‚'
                };
                document.getElementById('uncleDialog').innerHTML =
                    'ğŸ‘´ å­—èŠ‚å”<br>' + hints[this.technique];
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        const game = new IOManagementGame();
        game.init();
    </script>
</body>
</html>
